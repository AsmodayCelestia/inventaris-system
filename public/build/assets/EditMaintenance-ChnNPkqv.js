import{u as se,r as b,c as _,o as te,E as le,B as ne,b as u,e,t as d,g as E,H as P,I as oe,i as f,j as V,w as g,v as k,F as U,h as R,G as j,f as ue,l as i,q as C,s as ie}from"./app-6lUI17Zo.js";const de={class:"content-header"},re={class:"container-fluid"},ce={class:"row mb-2"},me={class:"col-sm-6"},ve={class:"m-0"},pe={class:"col-sm-6"},_e={class:"breadcrumb float-sm-right"},fe={class:"breadcrumb-item"},be={class:"breadcrumb-item"},ge={class:"breadcrumb-item active"},he={class:"content"},ke={class:"container-fluid"},ye={key:0,class:"card card-danger"},we={key:1,class:"card"},xe={class:"card-body"},De=["disabled"],Me={key:2,class:"card"},Se={class:"card-body"},Ue={class:"form-group"},Re=["disabled"],Te={class:"form-group"},Ee=["disabled"],Pe={class:"card-footer"},Ve=["disabled"],Ce={key:3,class:"card"},Le={class:"card-body bg-light"},Be={class:"table table-borderless mb-0"},Ne={class:"text-muted"},Ae={key:0},Fe={class:"d-flex gap-2"},Ge=["src"],Ie={class:"card-footer"},je=["disabled"],Je={key:4,class:"card"},$e={class:"card-header"},qe={class:"card-body"},He={class:"form-group"},Oe=["disabled"],Ke={key:0,class:"text-danger"},Ze={class:"form-group"},ze=["disabled"],Qe={key:0,class:"text-danger"},We={class:"form-group"},Xe=["disabled"],Ye={key:0,class:"text-danger"},ea={class:"form-group"},aa=["disabled"],sa={key:0,class:"text-danger"},ta={class:"form-group"},la=["disabled"],na=["value"],oa={key:0,class:"text-danger"},ua={class:"form-group"},ia=["disabled"],da={key:0,class:"text-danger"},ra={class:"custom-file"},ca=["disabled","onChange"],ma={class:"custom-file-label"},va={key:0,class:"mt-2"},pa=["src"],_a={key:0,class:"form-check mt-2"},fa=["onUpdate:modelValue","disabled"],ba={key:1,class:"text-danger"},ga={key:0,class:"form-group"},ha=["value"],ka={class:"card-footer"},ya=["disabled"],Da={__name:"EditMaintenance",setup(wa){const w=le(),x=ne(),c=se(),m=b(!1),J=b(null),v=b({}),o=b(null),L=b([]),l=b({inspection_date:"",issue_found:"",solution_taken:"",notes:"",status:"",cost:null,user_id:null}),y=b([null,null,null]),S=b(["","",""]),T=b(["","",""]),D=b([!1,!1,!1]),$=["reported","on_progress","handled","done","cancelled"],q={reported:"Dilaporkan",on_progress:"Dalam Proses",handled:"Ditangani",done:"Selesai",cancelled:"Dibatalkan"},H=_(()=>{var n;return((n=o.value)==null?void 0:n.creator_id)===c.userId}),B=_(()=>{var n,a,t;return[(n=o.value)==null?void 0:n.photo_1,(a=o.value)==null?void 0:a.photo_2,(t=o.value)==null?void 0:t.photo_3].filter(Boolean)}),r=_(()=>{var p;const n=c.userRole,a=c.userDivisi,t=(p=o.value)==null?void 0:p.status;if(["admin","head"].includes(n))return"full";if(n==="karyawan"&&a==="Umum"){if(t==="reported")return"umum-selfassign";if(t==="on_progress")return"umum-update"}return t==="on_progress"&&(c.isRoomSupervisor||H.value)?"mini-cancel":t==="handled"&&c.isRoomSupervisor?"pengawas-mark-done":"forbidden"}),O=_(()=>["full"].includes(r.value)),N=_(()=>["full","umum-update","mini-cancel","pengawas-mark-done"].includes(r.value)),K=_(()=>["full","umum-update"].includes(r.value)),A=_(()=>["full","umum-update","mini-cancel","pengawas-mark-done"].includes(r.value)),Z=_(()=>["full","umum-update","mini-cancel","pengawas-mark-done"].includes(r.value)),z=_(()=>["full","umum-update"].includes(r.value)),F=_(()=>["full","umum-update"].includes(r.value));_(()=>r.value==="full");const Q=_(()=>{switch(r.value){case"umum-update":return["handled","cancelled"];case"mini-cancel":return["cancelled"];case"pengawas-mark-done":return["done"];default:return $}}),G=_(()=>{switch(r.value){case"umum-selfassign":return"Ambil Tugas";case"mini-cancel":return"Batalkan Laporan";case"pengawas-mark-done":return"Tandai Selesai";case"full":return"Edit Laporan";case"umum-update":return"Update Progress";default:return"Maintenance"}});function W(n,a){const t=+a.split("_")[1]-1,p=n.target.files[0];if(!p){l.value[a]=null,y.value[t]=null,T.value[t]="",D.value[t]=!1;return}l.value[a]=p,y.value[t]=URL.createObjectURL(p),T.value[t]=p.name,D.value[t]=!1}function I(n){return n?new Date(n).toLocaleDateString("id-ID",{timeZone:"Asia/Jakarta",year:"numeric",month:"long",day:"numeric"}):"-"}te(async()=>{const n=w.params.id;m.value=!0,await c.authReady;try{o.value=await c.fetchMaintenanceDetail(n);const t=(o.value.inspection_date||"").match(/\d{4}-\d{2}-\d{2}/),p=t?t[0]:"";l.value={inspection_date:p,issue_found:o.value.issue_found||"",solution_taken:o.value.solution_taken||"",notes:o.value.notes||"",status:o.value.status,cost:o.value.cost??null,user_id:o.value.user_id??null},S.value=[o.value.photo_1||"",o.value.photo_2||"",o.value.photo_3||""],["admin","head"].includes(c.userRole)&&(await c.fetchUsersList("Umum"),L.value=c.usersList),console.log("raw date:",o.value.inspection_date),console.log("formatted:",I(o.value.inspection_date))}catch(a){J.value=a.message||"Gagal memuat data",x.push("/maintenance/list")}finally{m.value=!1}});async function X(){var n,a;m.value=!0;try{await c.assignMaintenance(w.params.id,{user_id:c.userId}),alert("Tugas diambil!"),x.push("/maintenance/list")}catch(t){alert("Gagal: "+(((a=(n=t.response)==null?void 0:n.data)==null?void 0:a.message)||t.message))}finally{m.value=!1}}async function Y(){var t,p,M;m.value=!0,v.value={};const n=new FormData,a=new Set(["inspection_date","issue_found","solution_taken","notes","status","cost","user_id","photo_1","photo_2","photo_3"]);Object.keys(l.value).forEach(s=>{a.has(s)&&l.value[s]!=null&&n.append(s,l.value[s])}),["photo_1","photo_2","photo_3"].forEach((s,h)=>{n.append(`remove_${s}`,D.value[h]?"1":"0"),y.value[h]&&l.value[s]&&n.append(s,l.value[s])});try{await c.updateMaintenanceRecord(w.params.id,n),alert("Berhasil disimpan!"),x.push("/maintenance/list")}catch(s){((t=s.response)==null?void 0:t.status)===422?v.value=s.response.data.errors:alert("Gagal: "+(((M=(p=s.response)==null?void 0:p.data)==null?void 0:M.message)||s.message))}finally{m.value=!1}}async function ee(){var n,a;m.value=!0;try{await c.updateMaintenanceRecord(w.params.id,{_method:"PUT",issue_found:l.value.issue_found,notes:l.value.notes,status:"cancelled"}),alert("Maintenance dibatalkan."),x.push("/maintenance/list")}catch(t){alert("Gagal: "+(((a=(n=t.response)==null?void 0:n.data)==null?void 0:a.message)||t.message))}finally{m.value=!1}}async function ae(){var n,a;m.value=!0;try{await c.updateMaintenanceRecordJson(w.params.id,{issue_found:l.value.issue_found,notes:l.value.notes,status:"done"}),alert("Ditandai selesai!"),x.push("/maintenance/list")}catch(t){alert("Gagal: "+(((a=(n=t.response)==null?void 0:n.data)==null?void 0:a.message)||t.message))}finally{m.value=!1}}return(n,a)=>{var p,M;const t=oe("router-link");return i(),u("div",null,[e("div",de,[e("div",re,[e("div",ce,[e("div",me,[e("h1",ve,d(G.value),1)]),e("div",pe,[e("ol",_e,[e("li",fe,[E(t,{to:"/dashboard"},{default:P(()=>a[9]||(a[9]=[C("Home",-1)])),_:1,__:[9]})]),e("li",be,[E(t,{to:"/maintenance/list"},{default:P(()=>a[10]||(a[10]=[C("Maintenance",-1)])),_:1,__:[10]})]),e("li",ge,d(G.value),1)])])])])]),e("div",he,[e("div",ke,[r.value==="forbidden"?(i(),u("div",ye,a[11]||(a[11]=[e("div",{class:"card-header"},"Akses Ditolak",-1),e("div",{class:"card-body"}," Kamu tidak memiliki hak untuk mengubah maintenance ini. ",-1)]))):r.value==="umum-selfassign"?(i(),u("div",we,[a[13]||(a[13]=e("div",{class:"card-header"},"Ambil Tugas",-1)),e("div",xe,[a[12]||(a[12]=e("p",null,"Kamu akan menjadi PJ untuk maintenance ini.",-1)),e("button",{class:"btn btn-success",onClick:X,disabled:m.value},d(m.value?"Menyimpan...":"Ambil Tugas"),9,De)])])):r.value==="mini-cancel"?(i(),u("div",Me,[a[16]||(a[16]=e("div",{class:"card-header"},"Batalkan Laporan",-1)),e("form",{onSubmit:V(ee,["prevent"])},[e("div",Se,[e("div",Ue,[a[14]||(a[14]=e("label",null,"Masalah yang Ditemukan",-1)),g(e("textarea",{"onUpdate:modelValue":a[0]||(a[0]=s=>l.value.issue_found=s),class:"form-control",rows:"3",disabled:!N.value},null,8,Re),[[k,l.value.issue_found]])]),e("div",Te,[a[15]||(a[15]=e("label",null,"Catatan",-1)),g(e("textarea",{"onUpdate:modelValue":a[1]||(a[1]=s=>l.value.notes=s),class:"form-control",rows:"2",disabled:!A.value},null,8,Ee),[[k,l.value.notes]])])]),e("div",Pe,[e("button",{type:"submit",class:"btn btn-warning",disabled:m.value}," Batalkan Maintenance ",8,Ve)])],32)])):r.value==="pengawas-mark-done"?(i(),u("div",Ce,[a[24]||(a[24]=e("div",{class:"card-header"},"Tandai Selesai",-1)),e("form",{onSubmit:V(ae,["prevent"])},[e("div",Le,[a[23]||(a[23]=e("h5",null,"Ringkasan Maintenance",-1)),e("table",Be,[e("tbody",null,[e("tr",null,[a[17]||(a[17]=e("td",{style:{width:"160px"}},[e("b",null,"Tanggal")],-1)),e("td",null,d(I(o.value.inspection_date)),1)]),e("tr",null,[a[18]||(a[18]=e("td",null,[e("b",null,"PJ")],-1)),e("td",null,d(((p=o.value.responsible_person)==null?void 0:p.name)??"-"),1)]),e("tr",null,[a[19]||(a[19]=e("td",null,[e("b",null,"Dibuat oleh")],-1)),e("td",null,d(((M=o.value.creator)==null?void 0:M.name)??"-"),1)]),e("tr",null,[a[20]||(a[20]=e("td",null,[e("b",null,"Biaya estimasi")],-1)),e("td",null,"Rp "+d(o.value.cost?Number(o.value.cost).toLocaleString("id-ID"):"-"),1)]),e("tr",null,[a[21]||(a[21]=e("td",null,[e("b",null,"Masalah")],-1)),e("td",Ne,d(o.value.issue_found??"-"),1)]),B.value.length?(i(),u("tr",Ae,[a[22]||(a[22]=e("td",null,[e("b",null,"Foto")],-1)),e("td",null,[e("div",Fe,[(i(!0),u(U,null,R(B.value,(s,h)=>(i(),u("img",{key:h,src:s,class:"img-thumbnail",style:{width:"120px",height:"90px","object-fit":"cover"}},null,8,Ge))),128))])])])):f("",!0)])])]),e("div",Ie,[e("button",{type:"submit",class:"btn btn-success",disabled:m.value}," Tandai Selesai ",8,je)])],32)])):r.value==="full"||r.value==="umum-update"?(i(),u("div",Je,[e("div",$e,d(r.value==="full"?"Edit Laporan":"Update Progress"),1),e("form",{onSubmit:V(Y,["prevent"]),enctype:"multipart/form-data"},[e("div",qe,[e("div",He,[a[25]||(a[25]=e("label",null,"Tanggal Pemeriksaan",-1)),g(e("input",{type:"date","onUpdate:modelValue":a[2]||(a[2]=s=>l.value.inspection_date=s),class:"form-control",disabled:!O.value,required:""},null,8,Oe),[[k,l.value.inspection_date]]),v.value.inspection_date?(i(),u("small",Ke,d(v.value.inspection_date[0]),1)):f("",!0)]),e("div",Ze,[a[26]||(a[26]=e("label",null,"Masalah yang Ditemukan",-1)),g(e("textarea",{"onUpdate:modelValue":a[3]||(a[3]=s=>l.value.issue_found=s),class:"form-control",rows:"3",disabled:!N.value,placeholder:"Deskripsikan masalah..."},null,8,ze),[[k,l.value.issue_found]]),v.value.issue_found?(i(),u("small",Qe,d(v.value.issue_found[0]),1)):f("",!0)]),e("div",We,[a[27]||(a[27]=e("label",null,"Tindakan Perbaikan",-1)),g(e("textarea",{"onUpdate:modelValue":a[4]||(a[4]=s=>l.value.solution_taken=s),class:"form-control",rows:"3",disabled:!K.value,placeholder:"Langkah yang dilakukan..."},null,8,Xe),[[k,l.value.solution_taken]]),v.value.solution_taken?(i(),u("small",Ye,d(v.value.solution_taken[0]),1)):f("",!0)]),e("div",ea,[a[28]||(a[28]=e("label",null,"Catatan Tambahan",-1)),g(e("textarea",{"onUpdate:modelValue":a[5]||(a[5]=s=>l.value.notes=s),class:"form-control",rows:"2",disabled:!A.value,placeholder:"Catatan opsional..."},null,8,aa),[[k,l.value.notes]]),v.value.notes?(i(),u("small",sa,d(v.value.notes[0]),1)):f("",!0)]),e("div",ta,[a[29]||(a[29]=e("label",null,"Status",-1)),g(e("select",{"onUpdate:modelValue":a[6]||(a[6]=s=>l.value.status=s),class:"form-control",disabled:!Z.value,required:""},[(i(!0),u(U,null,R(Q.value,s=>(i(),u("option",{key:s,value:s},d(q[s]),9,na))),128))],8,la),[[j,l.value.status]]),v.value.status?(i(),u("small",oa,d(v.value.status[0]),1)):f("",!0)]),e("div",ua,[a[30]||(a[30]=e("label",null,"Biaya (Rp)",-1)),g(e("input",{type:"number",class:"form-control","onUpdate:modelValue":a[7]||(a[7]=s=>l.value.cost=s),min:"0",disabled:!z.value},null,8,ia),[[k,l.value.cost,void 0,{number:!0}]]),v.value.cost?(i(),u("small",da,d(v.value.cost[0]),1)):f("",!0)]),(i(),u(U,null,R([1,2,3],s=>e("div",{key:s,class:"form-group"},[e("label",null,"Foto "+d(s),1),e("div",ra,[e("input",{type:"file",class:"custom-file-input",accept:"image/*",disabled:!F.value,onChange:h=>W(h,`photo_${s}`)},null,40,ca),e("label",ma,d(T.value[s-1]||"Pilih gambar..."),1)]),y.value[s-1]||S.value[s-1]?(i(),u("div",va,[e("img",{src:y.value[s-1]||S.value[s-1],class:"img-thumbnail",style:{"max-width":"200px"}},null,8,pa),S.value[s-1]&&!y.value[s-1]?(i(),u("div",_a,[g(e("input",{type:"checkbox",class:"form-check-input","onUpdate:modelValue":h=>D.value[s-1]=h,disabled:!F.value},null,8,fa),[[ie,D.value[s-1]]]),a[31]||(a[31]=e("label",{class:"form-check-label"},"Hapus gambar yang ada",-1))])):f("",!0)])):f("",!0),v.value[`photo_${s}`]?(i(),u("small",ba,d(v.value[`photo_${s}`][0]),1)):f("",!0)])),64)),["admin","head"].includes(ue(c).userRole)?(i(),u("div",ga,[a[33]||(a[33]=e("label",null,"Penanggung Jawab",-1)),g(e("select",{"onUpdate:modelValue":a[8]||(a[8]=s=>l.value.user_id=s),class:"form-control"},[a[32]||(a[32]=e("option",{value:null},"-- Tidak ada --",-1)),(i(!0),u(U,null,R(L.value,s=>(i(),u("option",{key:s.id,value:s.id},d(s.name),9,ha))),128))],512),[[j,l.value.user_id]])])):f("",!0)]),e("div",ka,[e("button",{type:"submit",class:"btn btn-primary",disabled:m.value},d(m.value?"Menyimpan...":"Simpan Perubahan"),9,ya),E(t,{to:"/maintenance/list",class:"btn btn-secondary ml-2"},{default:P(()=>a[34]||(a[34]=[C("Batal",-1)])),_:1,__:[34]})])],32)])):f("",!0)])])])}}};export{Da as default};
