import{u as ie,r as h,a as J,c as k,o as re,b as o,d as ue,e,w as B,v as F,f as _,g as O,C as R,F as w,h as K,i as T,n as N,j as P,t as g,k as I,l as d,m as Q,p as X}from"./app-DjNxOoL9.js";const ce={class:"content"},pe={class:"container-fluid"},me={class:"card"},ve={class:"card-body"},be={class:"row"},ge={class:"col-md-3 mb-2"},he={class:"col-md-4 mb-2"},ye={class:"input-group"},fe={class:"col-md-3 mb-2"},ke={class:"col-md-2 mb-2"},_e={class:"col-md-2 mb-2"},we={class:"card"},Pe={class:"card-body"},$e={key:0,class:"text-center p-4"},De={key:1,class:"alert alert-info m-3"},Se={key:2},Te={class:"table table-striped"},Ie=["onClick"],Ce={class:"pagination justify-content-center"},Le={class:"page-item"},je={key:0,class:"page-item disabled"},Ve=["onClick"],Ae={key:0,class:"page-item disabled"},Me={class:"page-item"},xe={class:"modal-dialog modal-lg"},Ue={class:"modal-content"},Be={class:"modal-body"},Fe=["innerHTML"],Y=2,Ne={__name:"ActivityLog",setup(Oe){const u=ie(),C=h([]),L=h(!1),j=h(null),V=h(""),l=J({search:"",modelType:[],event:[],userId:[],dateFrom:"",dateTo:""}),n=J({currentPage:1,perPage:10,total:0}),E=h([]),z=h([]),Z=["created","updated","deleted"],y=k(()=>n.currentPage),p=k(()=>Math.max(1,Math.ceil(n.total/n.perPage))),A=k(()=>Math.max(1,y.value-Y)),M=k(()=>Math.min(p.value,y.value+Y)),ee=k(()=>{const s=[];for(let t=A.value;t<=M.value;t++)s.push(t);return s.length?s:[1]}),f=async()=>{L.value=!0;try{const s=new URLSearchParams;s.set("page",n.currentPage),s.set("per_page",n.perPage),l.search&&s.set("search",l.search),l.dateFrom&&s.set("date_from",l.dateFrom),l.dateTo&&s.set("date_to",l.dateTo),l.modelType.length&&s.set("model_type",l.modelType.join(",")),l.event.length&&s.set("event",l.event.join(",")),l.userId.length&&s.set("user_id",l.userId.join(","));const{data:t}=await I.get(`${u.API_BASE_URL}/activity-log/datatable?${s}`,{headers:{Authorization:`Bearer ${u.token}`}});C.value=t.data,n.total=t.recordsTotal}catch(s){console.error(s)}finally{L.value=!1}},te=async()=>{try{const[s,t]=await Promise.all([I.get(`${u.API_BASE_URL}/activity-log/models`,{headers:{Authorization:`Bearer ${u.token}`}}),I.get(`${u.API_BASE_URL}/activity-log/users`,{headers:{Authorization:`Bearer ${u.token}`}})]);E.value=Object.entries(s.data).map(([a,m])=>({label:a,value:m})),z.value=Object.entries(t.data).map(([a,m])=>({id:Number(a),name:m}))}catch(s){console.error(s)}},W=(()=>{let s;return()=>{clearTimeout(s),s=setTimeout(c,400)}})(),c=()=>{n.currentPage=1,f()},ae=()=>{Object.assign(l,{search:"",modelType:[],event:[],userId:[],dateFrom:"",dateTo:""}),c()},se=()=>{n.currentPage>1&&(n.currentPage--,f())},le=()=>{n.currentPage<p.value&&(n.currentPage++,f())},x=s=>{n.currentPage=s,f()},ne=async s=>{try{const{data:t}=await I.get(`${u.API_BASE_URL}/activity-log/${s}/detail`,{headers:{Authorization:`Bearer ${u.token}`}});V.value=oe(t),await Q(),new X.Modal(j.value).show()}catch(t){console.error(t),V.value='<div class="text-danger">Gagal memuat detail</div>',await Q(),new X.Modal(j.value).show()}},oe=s=>{const{event:t,causer:a,subject:m,created_at:de,old:$,new:D}=s,H={},G=q=>Object.entries(q||{}).map(([v,i])=>{const U=H[v]||v;let r=i;return(v.endsWith("_at")||v==="procurement_date")&&(r=new Date(i).toLocaleDateString("id-ID")),v==="purchase_price"&&(r=`Rp ${Number(i).toLocaleString("id-ID")}`),`<tr><td>${U}</td><td>${r??"-"}</td></tr>`});let S=`
    <div class="mb-2">
      <strong>Aksi:</strong> <span class="badge badge-primary">${t.toUpperCase()}</span><br>
      <strong>Pengguna:</strong> ${a||"System"}<br>
      <strong>Subject:</strong> ${m}<br>
      <strong>Waktu:</strong> ${new Date(de).toLocaleString("id-ID")}
    </div>`;if(t==="updated"&&Object.keys($).length&&Object.keys(D).length){const v=[...new Set([...Object.keys($),...Object.keys(D)])].map(i=>{const U=H[i]||i;let r=$[i],b=D[i];return(i.endsWith("_at")||i==="procurement_date")&&(r=r?new Date(r).toLocaleDateString("id-ID"):"-",b=b?new Date(b).toLocaleDateString("id-ID"):"-"),i==="purchase_price"&&(r=r?`Rp ${Number(r).toLocaleString("id-ID")}`:"-",b=b?`Rp ${Number(b).toLocaleString("id-ID")}`:"-"),`<tr><td>${U}</td><td>${r??"-"}</td><td>${b??"-"}</td></tr>`}).join("");S+=`<h6 class="mt-3">Perubahan:</h6>
             <table class="table table-sm table-bordered">
               <thead><tr><th>Field</th><th>Lama</th><th>Baru</th></tr></thead>
               <tbody>${v}</tbody>
             </table>`}else t==="created"?S+=`<h6 class="mt-3">Data baru:</h6>
             <table class="table table-sm table-bordered"><tbody>${G(D).join("")}</tbody></table>`:t==="deleted"&&(S+=`<h6 class="mt-3">Data lama:</h6>
             <table class="table table-sm table-bordered"><tbody>${G($).join("")}</tbody></table>`);return S};return re(()=>{te(),f()}),(s,t)=>(d(),o(w,null,[t[22]||(t[22]=ue('<div class="content-header"><div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1 class="m-0">Activity Log</h1></div></div></div></div>',1)),e("div",ce,[e("div",pe,[e("div",me,[t[15]||(t[15]=e("div",{class:"card-header"},[e("h5",null,"Filter & Pencarian")],-1)),e("div",ve,[e("div",be,[e("div",ge,[t[9]||(t[9]=e("label",null,"Cari",-1)),B(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>l.search=a),onInput:t[1]||(t[1]=(...a)=>_(W)&&_(W)(...a)),class:"form-control",placeholder:"teks apa pun"},null,544),[[F,l.search]])]),e("div",he,[t[11]||(t[11]=e("label",null,"Rentang Tanggal",-1)),e("div",ye,[B(e("input",{type:"date","onUpdate:modelValue":t[2]||(t[2]=a=>l.dateFrom=a),class:"form-control",onChange:c},null,544),[[F,l.dateFrom]]),t[10]||(t[10]=e("div",{class:"input-group-prepend input-group-append"},[e("span",{class:"input-group-text"},"s/d")],-1)),B(e("input",{type:"date","onUpdate:modelValue":t[3]||(t[3]=a=>l.dateTo=a),class:"form-control",onChange:c},null,544),[[F,l.dateTo]])])]),e("div",fe,[t[12]||(t[12]=e("label",null,"Model",-1)),O(_(R),{options:E.value,modelValue:l.modelType,"onUpdate:modelValue":t[4]||(t[4]=a=>l.modelType=a),reduce:a=>a.value,label:"label",multiple:"",placeholder:"Semua",onInput:c},null,8,["options","modelValue","reduce"])]),e("div",ke,[t[13]||(t[13]=e("label",null,"Event",-1)),O(_(R),{options:Z,modelValue:l.event,"onUpdate:modelValue":t[5]||(t[5]=a=>l.event=a),multiple:"",placeholder:"Semua",onInput:c},null,8,["modelValue"])]),e("div",_e,[t[14]||(t[14]=e("label",null,"User",-1)),O(_(R),{options:z.value,modelValue:l.userId,"onUpdate:modelValue":t[6]||(t[6]=a=>l.userId=a),label:"name",reduce:a=>a.id,multiple:"",placeholder:"Semua",onInput:c},null,8,["options","modelValue","reduce"])]),e("div",{class:"col-md-2 mb-2 align-self-end"},[e("button",{class:"btn btn-primary w-100",onClick:c},"Terapkan")]),e("div",{class:"col-md-2 mb-2 align-self-end"},[e("button",{class:"btn btn-secondary w-100",onClick:ae},"Reset")])])])]),e("div",we,[t[20]||(t[20]=e("div",{class:"card-header"},[e("h3",{class:"card-title"},"Daftar Aktivitas")],-1)),e("div",Pe,[L.value?(d(),o("div",$e,t[16]||(t[16]=[e("i",{class:"fas fa-spinner fa-spin fa-2x"},null,-1),e("p",{class:"mt-2"},"Memuat data aktivitas...",-1)]))):C.value.length?(d(),o("div",Se,[e("table",Te,[t[17]||(t[17]=e("thead",null,[e("tr",null,[e("th",null,"User"),e("th",null,"Deskripsi"),e("th",null,"Model"),e("th",null,"Field Diubah"),e("th",null,"Waktu"),e("th",null,"Aksi")])],-1)),e("tbody",null,[(d(!0),o(w,null,K(C.value,a=>(d(),o("tr",{key:a.id},[e("td",null,g(a.user),1),e("td",null,g(a.description),1),e("td",null,g(a.model),1),e("td",null,g(a.changed_fields),1),e("td",null,g(a.created_at),1),e("td",null,[e("button",{class:"btn btn-sm btn-info",onClick:m=>ne(a.id)},"Detail",8,Ie)])]))),128))])]),e("nav",null,[e("ul",Ce,[e("li",{class:N(["page-item",{disabled:y.value===1}])},[e("a",{class:"page-link",href:"#",onClick:P(se,["prevent"])},"Previous")],2),A.value>1?(d(),o(w,{key:0},[e("li",Le,[e("a",{class:"page-link",href:"#",onClick:t[7]||(t[7]=P(a=>x(1),["prevent"]))},"1")]),A.value>2?(d(),o("li",je,t[18]||(t[18]=[e("span",{class:"page-link"},"...",-1)]))):T("",!0)],64)):T("",!0),(d(!0),o(w,null,K(ee.value,a=>(d(),o("li",{key:a,class:N(["page-item",{active:a===y.value}])},[e("a",{class:"page-link",href:"#",onClick:P(m=>x(a),["prevent"])},g(a),9,Ve)],2))),128)),M.value<p.value?(d(),o(w,{key:1},[M.value<p.value-1?(d(),o("li",Ae,t[19]||(t[19]=[e("span",{class:"page-link"},"...",-1)]))):T("",!0),e("li",Me,[e("a",{class:"page-link",href:"#",onClick:t[8]||(t[8]=P(a=>x(p.value),["prevent"]))},g(p.value),1)])],64)):T("",!0),e("li",{class:N(["page-item",{disabled:y.value===p.value}])},[e("a",{class:"page-link",href:"#",onClick:P(le,["prevent"])},"Next")],2)])])])):(d(),o("div",De,"Tidak ada aktivitas yang tercatat."))])])])]),e("div",{class:"modal fade",id:"detailModal",tabindex:"-1",ref_key:"detailModal",ref:j},[e("div",xe,[e("div",Ue,[t[21]||(t[21]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title"},"Detail Perubahan"),e("button",{type:"button",class:"close","data-dismiss":"modal"},"Ã—")],-1)),e("div",Be,[e("div",{innerHTML:V.value,class:"bg-light p-3 rounded"},null,8,Fe)])])])],512)],64))}};export{Ne as default};
